# 一、计数服务

## 模型抽象

> 尽可能列举会使用到计数服务的场景，从中熟悉业务场景，理解业务需求、可能的难点。同时调研业内使用的模型，进而抽象出适合自己业务的模型

### 电商场景

#### 用户主页

- 收藏夹---商品数，支持按时间查看、店铺查看
- 关注店铺数
- 最近足迹数

#### 商品

- 库存
- 销量
- 评价

### 视频网站场景

#### 用户主页

- 动态
  - 个人动态
  - 关注人的动态总数
- 关注
- 粉丝
- 虚拟币

#### 视频

- 播放量
- 点赞数
- 踩
- 评论
- 收藏
- 转发
- 投币数

### 短视频场景

####  用户主页

- 总获赞数
- 关注
- 粉丝
- 作品数
  - 公开数
  - 私密数
- 喜欢的作品数
- 收藏的作品数

#### 视频

- 播放量
- 点赞
- 评论
- 收藏
- 转发

### 微博场景

> 贴吧、脉脉、论坛、微博

#### 用户主页

- 关注
- 粉丝数
- 个人帖子总数

#### 帖子

- 点赞
- 评论
- 转发
- 分享

### 社交软件场景

> QQ、微信、飞书的未读消息、

- 未读消息总数
- 各个群、聊天框未读消息总数

### 小结

- 有些计数只是个数字，如库存、销量、视频/帖子等维度短视频点赞数、转发数
- 有些数字点击数字之后，需要能链接到具体的信息，如个人主页的关注、点赞、收藏等。这个信息肯定不是计数服务出，但是不是会需要计数服务提供一些关键 id 呢？--- 应该不需要，直接点击用户服务->获取相关列表信息即可，无需经过计数服务。计数服务只是提供了一个数字的展示

从以上场景来看，计数服务本质上就是解决：【某个实体有多少个数 】的问题

1. 不同的实体类型的计数会有差异吗？

   这里的计数肯定不是指单纯的加1减1，是指不同类型的实体其实可能会有不同的计数规则。计数规则是不是应该放到业务层，不应该耦合到计数服务中？

2. 目前来看，似乎计数服务只需要提供好加减技术接口和读接口就好，其实很像库存系统的计数，但是比库存系统的计数更简单（不需要有预扣、实际扣减等考虑）。所以是不是一个 key-value 就够了呢？

3. 计数服务与库存系统的区别

   1. 库存是商品的属性，虽然商品可能是实体也可能是虚拟，但从传统意义上讲，更多的还是实体。而不是像点赞、转发、关注这样的一种线上的虚拟行为。
   2. 影响库存的因素比较多，下单、退单、活动、区域调度等。而计数服务能支持的对象，通常能影响其数量的因素比较少，比较直接。

4. 如果只做一个 key-value 的话，计数服务能为业务提供的能力实际上是很有限的。为了给业务提供更好用的服务，实际是需要对业务场景做抽象的：

   1. 按发生时间段计数，比如过去一天、一周某个实体的点赞数、评论数
   2. 视频类型，各个时间段的播放量。比如前10分钟播放量是多少，后10分钟播放量是多少，能看到最后的播放量（完播量）

# 二、需求收集和总体架构设计

## 2.1 功能需求

遇到一个问题时，确定问题域和问题细节非常重要。设计一个系统，也是如此。一般来说，可以从以下四个方面进行思考：

**场景用例**

1. 系统的目标用户是谁
2. 用户具体是如何使用该系统

**数据量级**

从读写方面思考

1. 查询 qps
2. 写 qps
3. 每个请求的数据量
4. 是否有流量高峰

**性能**

1. 能容忍的写入数据到读取数据的延迟。决定该系统是近实时的流处理系统还是离线的批处理系统
2. P99 的延迟是多少
3. 高可用、容错性的考虑

> P99，指的是 10 秒内最慢的 1% 的请求的平均时延。可以认为是一个系统/接口的最坏情况下的表现

**成本**

1. 开发成本
2. 运维成本

明确完功能需求之后，系统的 API 也就可以定下来。API 就是系统用于支持功能需求的所能提供的原子能力。API 也是从读、写两个角度进行设计，以设计一个用于 B站视频 计算观看量、转发量、点赞量的系统为例，API 可以设计为：

![image-20220424000204652](https://typora-1258060977.cos.ap-beijing.myqcloud.com/img/image-20220424000204652.png)

## 2.2 非功能需求

主要可能是高并发、高性能、高可用

![image-20220424000436480](https://typora-1258060977.cos.ap-beijing.myqcloud.com/img/image-20220424000436480.png)

## 2.3 具体设计

在正式进入详细设计之前，需要给出一个简化的总体架构。这个架构主要是保证方案的总体思路和方向是符合预期的，是可以真正解决问题的。这一点保证之后，后续在详细设计时进行各种选型才有意义。

![image-20220424000711827](https://typora-1258060977.cos.ap-beijing.myqcloud.com/img/image-20220424000711827.png)

有了总体架构后，接下来需要自底向上进行设计。第一步就是解决数据存储的问题。

### 2.3.1 存储设计

系统需要满足可扩展、高性能、高可用，这三个要求在存储上的体现具体是什么呢？

可扩展：随着写入数据的增长，数据可以被低成本的迁移或直接通过增加存储设备的方式直接扩展，采用的方式是对数据进行**分区**

高性能：快速写入，高吞吐。快速写入可以借助内存缓存技术，通过提供批量接口，实现高吞吐。

高可用：不丢数据、灾难恢复，数据库慢或者不可用的场景。说明需要做数据的持久化、以及多副本技术、checkPoint 技术 



数据如何处理？

![image-20220424001819945](https://typora-1258060977.cos.ap-beijing.myqcloud.com/img/image-20220424001819945.png)

写入方式-计数服务->db

1. 每个用户请求都直接写 db
2. 一定时间区间内的用户请求，在计数服务中做聚合，再定期写 db

第1种方式的优点是，实时处理每个请求，缺点是频繁写 db，db 的写能力会是系统的瓶颈。第2种方式的优点是，db 的压力减小，系统的吞吐量变高，缺点是会引入一定的延迟。实际的系统中，一般采用第2种方式

写入方式-用户请求->计数服务

一般会在两者之间添加消息队列，用于：

1. 缓冲生产和消费不匹配的问题，进行流量削峰，对下游系统进行保护
2. 将生产者和消费者系统解耦，这样即使计数服务需要停机维护，也不会影响最终的技术准确性---高可用

### 2.3.2 计数消费者

![image-20220424003240812](https://typora-1258060977.cos.ap-beijing.myqcloud.com/img/image-20220424003240812.png)

**Partition**

生产者的分区，用于发送消息

**Partition Consumer**

分区消费者，即 MQ 的client 

**Aggregator**

聚合器，计数服务本身的核心逻辑。可以在这里完成具体的聚合策略：每分钟、每小时，聚合结果在内存中存储

**Internal Queue**

内部队列，需要是持久化的，可以再次使用 MQ。它的作用是存储聚合结果，也是与下游系统解耦

**DB writer**

负责将计算的聚合结果写入到 DB，实际业务场景中，写入到DB的数据除了计算结果外，还有一些额外的数据，因此需要做数据填充工作。数据来源可以是 DB，但如果填充的是一些静态数据（不会变化的数据），可以考虑将其存储到缓存中。这也是 Enrich Data Cache 引入的意义。

**Dead-letter Queue** 

尽管引入消息队列、DB writer 等组件，但 DB 不可用或写入慢的问题还是会可能出现。因此引入死信队列，用于存储在 DB 不可用期间、或写入慢导致无法成功写入的消息。再通过另外的消费线程去重试写入，保证数据的最终写入成功