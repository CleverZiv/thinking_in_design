## 21-27 分布式系统的本质

### 一、分布式系统起源和优缺点

#### 1.1 为什么使用分布式系统

1. 增大系统容量。随着业务量越来越大，单台机器无法承载，需要引入多台机器参与业务的承载。如何合理拆分任务到各个机器上呢？需要进行垂直（分模块，每个机器做业务流程中的一个节点的事）和水平（分流量，同一集群下不同机器执行的逻辑是相同的）
2. 加强系统可用。同一个逻辑交给不同机器去执行，消除单点故障，提供系统整体的可用性

#### 1.2 优缺点

优点：

1. 迭代简单
2. 技术多样且开放
3. 扩展性、重用性好
4. 故障影响范围小

缺点：

1. 经常发布，部署复杂---需要部署的流水线工具
2. 架构复杂
3. 响应时间慢，吞吐量大
4. 需要进行服务治理和调度管理

### 二、分布式系统中需要注意的问题

1. 异构系统的不标准问题：
   - 开发语言
   - 通讯协议
   - 数据格式
2. 服务之间的依赖问题：关键服务依赖非关键服务，非关键服务出问题会导致关键服务也跟着出问题。即服务依赖链中的“木桶短板效应”---整个 SLA 由最差的那个服务所决定
3. 故障发生的概率更大：服务多了，机器多了，故障发生概率自然就更大了，并且问题定位也会更复杂
4. 多层架构难运维
   - 通常系统会被分成四层：基础层、平台层、应用层和接入层。基础层就是机器、网络、存储设备等，平台层就是 Mysql、Redis、Kafka 等中间件，应用层就是我们的服务，接入层就是用户请求的第一跳，如AGW、Janus网关、CDN等
   - 任何一层出问题都会导致服务的故障。通常研发主要关注应用层，如果由其它层导致的问题，会使得研发在查问题时非常困难。除非研发对每一层都比较熟悉
   - 分层不是问题，问题是分层之后的协作是否统一和规范

### 三、分布式系统的核心关注点和技术栈

核心关注两点：

1. 提高整体架构的吞吐量，服务更多的并发和流量
2. 提高系统的稳定性，让系统可用性更高

#### 3.1 提高系统性能的技术

1. 负载均衡：负载均衡、服务路由、服务发现
2. 缓存系统：缓存分区、缓存更新、缓存命中
3. 异步调用：消息队列、消息持久、异步事务
4. 数据镜像：主库从库，数据同步、读写分离、数据一致性
5. 数据分区：分库分表、分区策略、数据访问层、数据一致性

以上提到的任何一个技术，都是有很多细节可以深挖的。

一般来说，在初期会使用读写分离的数据镜像方式，后期采用分库分表的数据分区的方式

#### 3.2 提高架构的稳定性

1. 服务拆分：隔离故障、重复服务、服务调用、服务依赖
2. 服务冗余：去除单点，对于有状态的服务，由于数据有状态，服务迁移很复杂
3. 限流降级：当系统扛不住压力时，只能通过限流或功能降级（不调用某些服务，比如图片加载）的方式来停掉一部分服务，或是拒绝一部分用户，以确保整个架构不会挂掉
4. 高可用架构：从冗余架构的角度来保障可用性，消除单点故障
5. 高可用运维：DevOps 中的 CI/CD 等，就是研发经常使用的上线、监控、问题排查那一类东西

#### 3.3 分布式系统的核心技术

1. 全栈系统监控 --- 系统分层、服务拆分后故障概率大，需要有全面的监控系统
2. 服务/资源调度--- 多服务、多机器需要进行合理的管理调度
3. 流量调度---大流量如何合理分发到不同服务的不同机器
4. 状态/数据调度--- 为防止单点故障，引入冗余架构，冗余架构如何做数据迁移
5. 开发和运维的自动化--- 以上四点都做到了，才有可能实现这一点

![image-20220103171516946](/Users/lengzefu/typoimage/image-20220103171516946.png)

### 四、服务调度

服务关键程度：即人为地根据对业务的理解程度，将服务定义为 P0~PN

服务依赖关系/调用关系：梳理出一个完整的服务调用地图是很有必要的，一定不能出现循环依赖的情况。

如何定义循环依赖？

- 严格的定义下：循环依赖就是 A 调用 B，B 调用 C，C 又调用 A，构成了循环依赖。

- 宽松定义下：在同一个请求流程中，A 调用 B，B 调用 C，C 又调用 A，构成了循环依赖。

应该禁止出现第二种情况，尽量避免第一种情况



**服务工作流和服务编排**：

把一堆微服务通过一定的机制编排起来，形成一套工作流。

编排就像一个乐队的指挥，告诉每个乐手什么时候该做什么事，最后形成了工作流，产生了悦耳的乐曲。对于软件来说，就是完成了一个业务流程。

**那使用什么机制将微服务编排起来呢？**

在微服务中，使用的是轻量的中间件。比如 API Gateway 或消息队列。或是如陈皓在文章（2017年底）中所说：关于服务的编排会直接导致一个服务编排的工作流引擎中间件的产生。---事实上，已经出现了（2022年初）

### 五、流量和数据调度

这些事是「API 网关」的职责：

1. 根据系统运行状况，自动进行流量调度
2. 流量突增时，也能保护系统平稳运行
3. 服务流控：发现、路由、降级、熔断、保护
4. 流量控制：负载均衡、流量分配、流量控制、异地灾备
5. 流量管理：协议转换、请求校验、数据缓存、数据计算

#### 5.1 状态数据调度

有状态的服务：服务会产生数据，数据是有状态的。迁移服务时，需要将数据一起迁移，否则会有问题。通过将状态数据存储到第三方服务：redis、mysql、zk 上避免状态数据与服务强耦合。将问题转移到了第三方服务。

那么对于存储服务来说，它就需要应对多机器、多流量的访问。但存储服务总有单点限制，因此存储服务也需要多副本，多副本就必然引入数据一致性的问题

#### 5.2 分布式事务一致性的问题

数据分区也是需要有数据副本的，数据分区会引入分布式事务的问题

数据副本是分布式系统中解决数据丢失异常的**唯一**手段。解决数据副本的一致性问题是，技术方案有：

1. 主从
2. 多主
3. 两阶段提交、三阶段提交
4. Paxos 算法

迄今为止，应用层的分布式事务解决方案基本是两阶段提交的变种：阿里的 TCC，亚马逊的 Plan-reserve_confirm，或是通过业务补偿；而在底层存储的数据层解决事务问题，Paxos 是不二之选，当然 Raft 也可以做到。

可以看到，已经有很多存储产品对外承诺提供的服务是分布式的，保证一致性的了。比如：TiDB、ElasticSearch、InfluxDB、MySQL Cluster和Redis Cluster 等。